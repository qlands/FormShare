{% extends 'dashboard/page.jinja2' %}
{% import 'dashboard/macros/form.jinja2' as form %}

{% block titlesection %}{{ _('Merge new version') }} {% endblock titlesection %}

{% block css %}
    {{ super() }}
    {% cssresource request,'formshare','switchery' %}
{% endblock css %}

{% block topScripts %}
    {{ super() }}
    {% jsresource request,'formshare','switchery' %}
{% endblock topScripts %}

{% block breadcrumbs %}
    {% include 'dashboard/projects/repository/snippets/brdcrbs_merge.jinja2' %}
{% endblock breadcrumbs %}

{% block mainsection %}
    <div class="row">
        <div class="col-md-12">
            <div  class="ibox">
                <div class="ibox-title">
                    <h5>{{ _('Merge form') }} "{{ formData.name }}" {{ _('into the repository of form') }} "{{ oldformData.name }}"</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link" style="margin-right: 10px">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="fullscreen-link">
                            <i class="fa fa-expand"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-md-12">
                            {% block merge_form_notes %}
                                <h3>{{ _("Important notes:") }}</h3>
                                <ul>
                                    <li>{{ _('FormShare will perform more checks on')}} "{{ formData.name }}" {{ _('and report whether or not is possible to merge it into the repository of') }} "{{ oldformData.name }}".<br/>{{ _('The following changes cannot be merged:') }}
                                        <ol>
                                            <li>{{ _('The primary key changes in any way.') }}</li>
                                            <li>{{ _('Changes in the structure of repeats. For example: In') }} "{{ oldformData.name }}" {{ _('you have repeat B inside repeat A but in ')}} "{{ formData.name }}" {{ _('you have repeat A and repeat C but repeat B is now inside C.') }}</li>
                                            <li>{{ _('Change a string variable into integer.') }}</li>
                                            <li>{{ _('Change a variable from select one into select multiple and the other way around.') }}</li>
                                            <li>{{ _('Change a variable from categorical into continuous and the other way around.') }}</li>
                                            <li>{{ _('Change the description of a option. For example: In')}} "{{ oldformData.name }}" {{ _('you have "1-Male" but in') }} "{{ formData.name }}" {{_('you have "1-Man". In this case FormShare will ask you if such change should be ignored because this could be a typo fix between versions, however') }} <span style="color: red">{{ _('YOU ASSUME THE RISK.') }}</span></li>
                                        </ol>
                                    </li>
                                    <li>{{ _('The merge will only apply incremental changes thus you will not lose data. If for example you removed a variable in')}} "{{ formData.name }}" {{_('such variable will always exist in the repository of') }} "{{ oldformData.name }}"</li>
                                    <li>{{ _('FormShare will apply the merge in a secure backup before any changes are made to the repository of') }} "{{ oldformData.name }}".</li>
                                    <li style="color: red">{{ _('Any form using such repository will not accept changes until the merge is committed or roll-backed.') }}</li>
                                </ul>
                            {% endblock merge_form_notes %}
                        </div>
                        <div class="col-md-12">
                            <hr>
                            {{ form.display_errors(errors,true) }}
                            {% for error in merge_errors %}
                                {% if errortype == 2 %}
                                    <div class="alert alert-danger">
                                        {{ error }}
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning">
                                        {{ error }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                            <div class="middle-box text-center">
                                {% if errortype == 1 %}
                                    {{ _('There are changes in the descriptions of certain choice options. You can merge such changes at') }} <b style="color: red">{{ _('YOUR OWN RISK') }} {{ _('by trying again') }}</b>
                                {% endif %}
                                <form id="form_update_form" role="form" method="post" enctype="multipart/form-data" action="{{ request.url }}">
                                    {% block merge_form %}
                                        {{ form.secure_form(request) }}
                                        {% if errortype == 1 %}
                                            <input type="hidden" name="valuestoignore" value="{{ valuestoignore }}">
                                        {% endif %}
                                        <div class="form-group">
                                            <label class="text-danger">{{ _('Discard all testing data (No by default)') }}</label>
                                            <input type="checkbox" name="discard_testing_data" class="js-switch"/>
                                            <span class="form-text m-b-none text-warning">{{ _('Change the switch if you DO NOT WANT to append the testing data into the repository') }}</span>
                                        </div>
                                        {% block merge_form_actions %}
                                            {% if errortype != 1 %}
                                                <button type="submit" style="margin-top: 10px" class="btn btn-primary">{{ _('Merge new version') }}</button>
                                            {% else %}
                                                <button type="submit" name="accept" style="margin-top: 10px" class="btn btn-primary">{{ _('Accept changes and merge new version') }}</button>
                                            {% endif %}
                                        {% endblock merge_form_actions %}
                                    {% endblock merge_form %}
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock mainsection %}

{% block scripts %}
    {{ super() }}
    <script>
        $(document).ready(function() {
            var elem = document.querySelector('.js-switch');
            var switchery = new Switchery(elem, { color: '#1AB394' });
            $('#form_update_form').submit(function() {
                $(this).find("button[type='submit']").prop('disabled',true);
            });
        });
    </script>
{% endblock scripts %}